image: node:20

stages:
  - prepare
  - test
  - security
  - deploy

variables:
  NPM_TOKEN: ${NPM_TOKEN}
  TEST_ENV_URL: "https://test-env.example.com"

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - .npm/

install_dependencies:
  stage: prepare
  script:
    - npm ci
  artifacts:
    paths:
      - node_modules/

lint:
  stage: test
  script:
    - npm run lint:check
    - npm run format:check

unit_tests:
  stage: test
  script:
    - npm run test
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml

e2e_tests:
  stage: test
  script:
    - npm run test:e2e

sonarqube:
  stage: test
  image: 
    name: sonarsource/sonar-scanner-cli
    entrypoint: [""]
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - sonar-scanner
  allow_failure: true
  only:
    - master
    - merge_requests

secret_detection:
  stage: security
  image: 
    name: gitlab/gitlab-runner-helper:latest
  script:
    - |
      curl -sSL https://raw.githubusercontent.com/gitleaks/gitleaks/master/install.sh | sh
      gitleaks detect --source . --verbose --report-format json --report-path leak_report.json
  artifacts:
    reports:
      security: leak_report.json
  allow_failure: false

dependency_scan:
  stage: security
  script:
    - npm audit
    - npm run snyk:test
  allow_failure: true

deploy_test:
  stage: deploy
  script:
    - npm run build
    - |
      echo "Deploying to test environment..."
      # Add your deployment script here
      # Example: deploy to kubernetes cluster
      # kubectl apply -f k8s/
  environment:
    name: test
    url: $TEST_ENV_URL
  only:
    - master
